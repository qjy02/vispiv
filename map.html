<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vispiv Map</title>
    <link
      rel="icon"
      href="Vispiv.png"
      type="image/png"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet-routing-machine@3.2.6/dist/leaflet-routing-machine.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@600&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Quicksand:wght@600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Quicksand", Verdana, sans-serif;
        background-color: #2c3e50;
        color: white;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 20px;
        padding: 20px;
      }

      .navbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        text-align: center;
        vertical-align: center;
        position: relative;
        background-color: #34495e;
        padding: 10px 20px;
        border-radius: 10px;
      }

      .navbar a {
        color: white;
        text-decoration: none;
        padding: 10px;
        font-weight: bold;
      }

      .navbar a:hover {
        background-color: #007bff;
        border-radius: 5px;
      }

      .navbar .menu-icon {
        display: none;
        font-size: 24px;
        cursor: pointer;
      }

      .navbar-links {
        display: flex;
        gap: 15px;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header h3 {
        flex-grow: 1;
        text-align: center;
        margin: 0;
        line-height: 50px;
      }

      .header img {
        margin-top: 5px;
      }

      .container {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        height: 100%;
        gap: 20px;
      }

      #search-container {
        background-color: #34495e;
        padding: 20px;
        border-radius: 10px;
        width: 30%;
        height: 60vh;
        display: flex;
        flex-direction: column;
      }

      #search-container h2 {
        margin: 0 0 10px;
        font-size: 24px;
        color: #fff;
        text-align: center;
      }

      #search-container input {
        width: 100%;
        padding: 12px;
        font-size: 16px;
        border: none;
        border-radius: 8px;
        box-sizing: border-box;
        margin-bottom: 15px;
        background-color: #fff;
        color: #333;
      }

      #search-container input:focus {
        outline: none;
        border: 2px solid #007bff;
      }

      .search-buttons {
        display: flex;
        justify-content: space-between;
        gap: 10px;
      }

      #search-container button {
        padding: 12px;
        font-size: 16px;
        border: none;
        border-radius: 8px;
        background-color: #007bff;
        font-family: "Quicksand", Verdana, sans-serif;
        color: white;
        cursor: pointer;
        flex-grow: 1;
      }

      #search-container button:hover {
        background-color: #0056b3;
      }

      #map-container {
        background-color: #34495e;
        border-radius: 10px;
        padding: 20px;
        width: 65%;
        height: 60vh; /* Matching height with search container */
      }

      #map {
        width: 100%;
        height: 100%;
        border-radius: 10px;
      }

      .vispiv-container {
        display: flex;
        text-align: center;
        justify-content: center;
        align-items: center;
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        font-weight: 600;
        color: #fff;
        margin-left: 5px;
      }

      .vispiv-container a:hover {
        background: none;
        border-radius: 0;
      }

      .vispiv-icon {
        margin-right: 10px;
        width: 60px;
        height: auto;
      }

      .navbar a.active {
        background-color: #04366d;
        border-radius: 5px;
      }

      .back-icon {
        cursor: pointer;
        font-size: 22px;
        color: white;
        transition: opacity 0.3s ease;
      }

      .back-icon:hover {
        opacity: 0.5;
        color: #007bff;
      }

      .search-input-fashion {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
        width: calc(100% - 24px);
        margin-bottom: 10px;
      }

      .suggestion-list-fashion {
        list-style: none;
        padding: 0;
        margin: 0;
        display: none;
        background: #fff;
        color: #333;
        max-height: 200px;
        overflow-y: auto;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        margin-top: 5px;
        z-index: 1998;
        width: 100%;
        margin-bottom: 20px;
        font-family: "Quicksand", Verdana, sans-serif;
      }

      .suggestion-list-fashion li {
        padding: 12px;
        cursor: pointer;
        transition: background-color 0.3s, box-shadow 0.3s ease,
          transform 0.3s ease;
        margin: 4px 0;
        box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
      }

      .suggestion-list-fashion li:nth-child(odd) {
        background-color: #fafafa;
      }

      .suggestion-list-fashion li:nth-child(even) {
        background-color: #fef4d0;
      }

      .suggestion-list-fashion li:hover {
        background-color: #007bff;
        color: white;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        transform: translateY(-2px);
      }

      .suggestion-list-fashion li.active {
        background-color: #0056b3;
        color: white;
        border-left: 4px solid #003366;
      }

      .menu-container {
        margin-left: auto;
        display: flex;
        align-items: center;
      }

      .menu-button {
        background: linear-gradient(145deg, #007b9e, #005d7e);
        color: white;
        border-radius: 5px;
        padding: 10px;
        cursor: pointer;
        width: 40px;
        height: 40px;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 3px 3px 6px rgba(0, 0, 0, 0.2),
          -3px -3px 6px rgba(255, 255, 255, 0.2);
        transition: all 0.2s ease-in-out;
        font-size: 1rem;
        font-weight: bold;
        border: 2px solid rgba(255, 255, 255, 0.2);
      }

      .menu-button:hover {
        background: linear-gradient(145deg, #0092b2, #006f96);
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3),
          -2px -2px 5px rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
      }

      .menu-button:active {
        transform: translateY(1px);
        box-shadow: inset 2px 2px 5px rgba(0, 0, 0, 0.3),
          inset -2px -2px 5px rgba(255, 255, 255, 0.2);
      }

      .dialog-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 999;
      }

      .popup-menu.dialog {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgb(113, 113, 113);
        color: white;
        padding: 20px;
        border-radius: 10px;
        border: 5px solid black;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        z-index: 9000;
        width: 90%;
        max-width: 400px;
        text-align: center;
      }

      .popup-menu.dialog a {
        display: block;
        color: white;
        text-decoration: none;
        padding: 12px 20px;
        background-color: #3a4045;
        border-radius: 5px;
        margin: 8px 0;
        font-size: 16px;
        transition: background-color 0.3s ease, transform 0.2s ease;
      }

      .popup-menu.dialog a:hover {
        background-color: #52575c;
        transform: scale(1.02);
      }

      .popup-menu {
        position: relative;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 36px;
        font-weight: bold;
        color: red;
        position: absolute;
        right: 10px;
        top: 10px;
        cursor: pointer;
        transition: transform 0.3s ease;
      }

      .close-btn:hover {
        transform: scale(1.2);
      }

      #loadingSpinner {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: #203454;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        z-index: 9999;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      #overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 9998;
      }

      .ukraine-flag {
        display: inline-block;
        width: 20px;
        height: 16px;
        background: linear-gradient(to bottom, #005bbb 50%, #ffd700 50%);
        vertical-align: top;
      }

      .zoom-link:hover {
        transform: scale(1.1);
        cursor: pointer;
      }

      .zoom-link {
        transition: transform 0.3s ease;
      }

      @media (max-width: 768px) {
        .container {
          flex-direction: column;
          align-items: center;
          padding: 20px;
        }

        .suggestion-list-fashion {
          width: 100%;
        }

        .popup-menu.dialog {
          width: 80%;
        }

        #search-container {
          width: 100%;
          margin-bottom: 20px;
          height: auto;
          padding: 20px;
        }

        #map-container {
          width: 100%;
          height: 50vh;
        }

        #map {
          height: 100%;
        }
      }

      #search-input::placeholder {
        font-family: "Quicksand", Verdana, sans-serif;
      }

      #from-location::placeholder,
      #to-location::placeholder {
        font-family: "Quicksand", Verdana, sans-serif;
      }
    </style>
  </head>

  <body>
    <div class="popup-menu dialog" id="popupMenu">
      <span><h2>Vispiv Links</h2></span>
      <span
        ><button onclick="togglePopup()" class="close-btn">
          <i class="fas fa-times"></i></button
      ></span>

      <a href="list.html">Vispiv List</a>
      <a href="jsonformatter.html">Json Formatter</a>
      <a href="jsongrid.html">Json2Grid</a>
      <a href="text_viewer_pdf.html">Text File Viewer</a>
      <a href="qrcodereader.html">QR Code Reader</a>
      <a href="calendar_view.html">Vispiv Calendar</a>
      <a href="musicplayer.html">Music Player</a>
    </div>

    <div class="navbar">
      <div class="vispiv-container">
        <a href="list.html" style="text-decoration: none">
          <img
            src="Vispiv.png"
            alt="Vispiv Icon"
            class="vispiv-icon"
          />
        </a>
        <span>Vispiv Map</span>
      </div>
      <div class="menu-container">
        <button class="menu-button" onclick="togglePopup()">
          <i class="fas fa-bars"></i>
        </button>
      </div>
    </div>

    <div class="container">
      <div id="search-container">
        <h2>Search Location</h2>
        <div id="single-search">
          <input
            type="text"
            id="search-input"
            placeholder="Enter a location"
            class="search-input-fashion"
          />
          <ul id="single-suggestion-list" class="suggestion-list-fashion">
            <!-- Suggestions will populate here dynamically -->
          </ul>

          <div class="search-buttons">
            <button onclick="searchLocation()">Search</button>
            <button onclick="switchToTwoLocations()">Get Routes</button>
          </div>
        </div>

        <div id="dual-search" style="display: none">
          <span
            class="back-icon"
            onclick="backToSingleSearch()"
            style="text-align: right; display: block; width: 100%"
            >🔙</span
          >
          <br />
          <label for="from-location">From:</label>
          <input
            type="text"
            id="from-location"
            placeholder="Enter starting point"
          />
          <label for="to-location">To:</label>
          <input type="text" id="to-location" placeholder="Enter destination" />
          <ul id="dual-suggestion-list" class="suggestion-list-fashion">
            <!-- Suggestions will populate here dynamically -->
          </ul>
          <div class="search-buttons">
            <button onclick="getDirections()">Get Directions</button>
          </div>
        </div>
      </div>

      <div id="map-container">
        <div id="map"></div>
        <div id="layer-controls" class="layer-controls-fashion"></div>
      </div>
    </div>

    <div>
      <footer style="text-align: center">
        <span>
          Copyright © 2024 Vispiv Collectives | Powered by Vispiv Collectives |
          <a
            href="https://stand-with-ukraine.pp.ua/"
            target="_blank"
            style="
              text-decoration: none;
              color: lightblue;
              display: inline-block;
              transition: transform 0.3s ease;
              max-width: 100%;
              margin-left: 5px;
              margin-right: 5px;
            "
            class="zoom-link"
          >
            Stand With Ukraine
          </a>
          <span class="ukraine-flag"></span>
        </span>
      </footer>
    </div>

    <div id="overlay" style="display: none"></div>
    <div id="loadingSpinner" style="display: none"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.5.0/dist/leaflet-routing-machine.js"></script>
    <script>
      const map = L.map("map").setView([2.2434, 102.2309], 13); // Default view: Jalan Cheng Perdana 1/24, Melaka, Malaysia

      const baseLayers = {
        OpenStreetMap: L.tileLayer(
          "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
          {
            maxZoom: 19,
            attribution:
              '&copy; <a href="http://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> contributors',
          }
        ),
        "Satellite View": L.tileLayer(
          "https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png",
          {
            maxZoom: 19,
            attribution:
              '&copy; <a href="http://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> contributors, Tiles style by <a href="https://www.hotosm.org/" target="_blank"> Humanitarian OpenStreetMap Team</a> hosted by <a href="https://openstreetmap.fr/" target="_blank">OpenStreetMap France</a>',
          }
        ),
        OpenTopoMap: L.tileLayer(
          "https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",
          {
            maxZoom: 17,
            attribution:
              'Map data: &copy; <a href="http://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org/" target="_blank">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org/" target="_blank">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/" target="_blank">CC-BY-SA</a>)',
          }
        ),
      };

      const overlayLayers = {
        "Traffic Layer": L.tileLayer(
          "https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=your_api_key",
          {
            attribution:
              '<a href="https://openweathermap.org/" target="_blank">OpenWeatherMap</a>',
            opacity: 0.5,
          }
        ),
      };

      // Add default base layer
      baseLayers.OpenStreetMap.addTo(map);

      // Add layer control to the map
      L.control.layers(baseLayers, overlayLayers).addTo(map);

      let marker = null;
      let routeControl; // For storing the route

      let firstLocation = null; // Store the first location for routing
      let secondLocation = null; // Store the second location for routing

      async function searchLocation() {
        const query = document.getElementById("search-input").value;

        if (!query) {
          alert("Please enter a location.");
          return;
        }

        // Show spinner and overlay
        document.getElementById("loadingSpinner").style.display = "block";
        document.getElementById("overlay").style.display = "block";

        try {
          // Fetch geocoding data from Nominatim
          const response = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&q=${query}`
          );
          const data = await response.json();

          if (data.length > 0) {
            const { lat, lon, display_name } = data[0];
            map.setView([lat, lon], 18); // Increased zoom level to 18 for 100% zoom-in effect

            // Clear existing route and markers from previous search/directions
            if (routePolyline) {
              map.removeLayer(routePolyline); // Remove the route polyline
              routePolyline = null; // Reset the polyline
            }

            existingMarkers.forEach((marker) => map.removeLayer(marker)); // Remove existing markers
            existingMarkers = []; // Reset the markers list

            // Add a new marker for the search location
            if (marker === null) {
              marker = L.marker([lat, lon]).addTo(map);
            } else {
              marker.setLatLng([lat, lon]);
            }
            marker.bindPopup(display_name).openPopup();

            firstLocation = { lat, lon }; // Store the first location
          } else {
            alert("Location not found.");
          }
        } catch (error) {
          console.error("Error searching location:", error);
          alert("Failed to search location. Please try again.");
        } finally {
          // Hide spinner and overlay when done
          document.getElementById("loadingSpinner").style.display = "none";
          document.getElementById("overlay").style.display = "none";
        }
      }

      function switchToTwoLocations() {
        // Switch to the "From" and "To" input fields
        document.getElementById("single-search").style.display = "none";
        document.getElementById("dual-search").style.display = "block";
      }

      function backToSingleSearch() {
        // Return to the default single search view
        document.getElementById("single-search").style.display = "block";
        document.getElementById("dual-search").style.display = "none";
      }

      let routePolyline = null; // To store the polyline of the route
      let existingMarkers = []; // To store the markers for cleanup

      async function getDirections() {
        const fromQuery = document.getElementById("from-location").value;
        const toQuery = document.getElementById("to-location").value;

        if (!fromQuery || !toQuery) {
          alert("Please enter both From and To locations.");
          return;
        }

        // Show spinner and overlay
        document.getElementById("loadingSpinner").style.display = "block";
        document.getElementById("overlay").style.display = "block";

        try {
          // Fetch geocoding data for "From"
          const fromResponse = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&q=${fromQuery}`
          );
          const fromData = await fromResponse.json();

          // Fetch geocoding data for "To"
          const toResponse = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&q=${toQuery}`
          );
          const toData = await toResponse.json();

          if (fromData.length > 0 && toData.length > 0) {
            const fromLatLng = [
              parseFloat(fromData[0].lat),
              parseFloat(fromData[0].lon),
            ];
            const toLatLng = [
              parseFloat(toData[0].lat),
              parseFloat(toData[0].lon),
            ];

            map.setView(fromLatLng, 14); // Center map on the "From" location

            // Clear any previous search location marker
            if (marker) {
              map.removeLayer(marker); // Remove the search location marker
              marker = null; // Reset marker
            }

            // Clear previous markers for "From" and "To"
            existingMarkers.forEach((marker) => map.removeLayer(marker));
            existingMarkers = []; // Reset the markers list

            // Add markers for "From" and "To" locations
            const fromMarker = L.marker(fromLatLng)
              .addTo(map)
              .bindPopup("Starting point: " + fromQuery);
            const toMarker = L.marker(toLatLng)
              .addTo(map)
              .bindPopup("Destination: " + toQuery);

            existingMarkers.push(fromMarker, toMarker);

            if (routePolyline) {
              map.removeLayer(routePolyline);
            }

            const directionsResponse = await fetch(
              `https://router.project-osrm.org/route/v1/driving/${fromLatLng[1]},${fromLatLng[0]};${toLatLng[1]},${toLatLng[0]}?overview=full&geometries=geojson`
            );
            const directionsData = await directionsResponse.json();

            if (directionsData.routes && directionsData.routes.length > 0) {
              const routeCoordinates =
                directionsData.routes[0].geometry.coordinates.map((coord) => [
                  coord[1],
                  coord[0],
                ]);

              routePolyline = L.polyline(routeCoordinates, {
                color: "blue",
                weight: 5,
                opacity: 0.7,
              }).addTo(map);

              map.fitBounds(routePolyline.getBounds());
            } else {
              alert("Route could not be determined.");
            }
          } else {
            alert("One or both locations not found.");
          }
        } catch (error) {
          console.error("Error getting directions:", error);
          alert("Failed to get directions. Please try again.");
        } finally {
          // Hide spinner and overlay when done
          document.getElementById("loadingSpinner").style.display = "none";
          document.getElementById("overlay").style.display = "none";
        }
      }

      let activeInputId = null;
      let suggestionTimeout;

      async function fetchSuggestions(query, inputId) {
        if (query.trim() === "") {
          document.getElementById("suggestion-list").style.display = "none";
          return;
        }

        clearTimeout(suggestionTimeout);

        suggestionTimeout = setTimeout(async () => {
          try {
            const response = await fetch(
              `https://nominatim.openstreetmap.org/search?format=json&q=${query}`
            );
            const data = await response.json();

            const suggestionListId =
              inputId === "search-input"
                ? "single-suggestion-list"
                : "dual-suggestion-list";
            const suggestionList = document.getElementById(suggestionListId);

            if (query.trim() === "") {
              suggestionList.style.display = "none";
              return;
            }
            suggestionList.innerHTML = "";

            if (data.length > 0) {
              data.forEach((item) => {
                const li = document.createElement("li");
                li.textContent = item.display_name;
                li.style.padding = "8px";
                li.style.cursor = "pointer";
                li.addEventListener("click", () => {
                  document.getElementById(inputId).value = item.display_name;
                  suggestionList.style.display = "none";
                });
                suggestionList.appendChild(li);
              });

              suggestionList.style.display = "block";
            } else {
              suggestionList.style.display = "none";
            }
          } catch (error) {
            console.error("Error fetching suggestions:", error);
          }
        }, 300);
      }

      ["search-input", "from-location", "to-location"].forEach((id) => {
        const input = document.getElementById(id);
        input.addEventListener("focus", () => {
          activeInputId = id;
        });

        input.addEventListener("input", (event) => {
          fetchSuggestions(event.target.value, id);
        });
      });

      document
        .getElementById("search-input")
        .addEventListener("keydown", function (event) {
          if (event.key === "Enter") {
            searchLocation();
          }
        });

      window.onload = function () {
        document.getElementById("search-input").focus();
      };

      function togglePopup() {
        const popupMenu = document.getElementById("popupMenu");

        // Toggle the visibility of the popup menu
        if (
          popupMenu.style.display === "none" ||
          popupMenu.style.display === ""
        ) {
          popupMenu.style.display = "block";
        } else {
          popupMenu.style.display = "none";
        }
      }

      window.addEventListener("click", (event) => {
        const popupMenu = document.getElementById("popupMenu");
        const menuButton = document.querySelector(".menu-button");

        // Close the popup if clicked outside
        if (
          !popupMenu.contains(event.target) &&
          event.target !== menuButton &&
          !menuButton.contains(event.target)
        ) {
          popupMenu.style.display = "none";
        }
      });
    </script>
  </body>
</html>
